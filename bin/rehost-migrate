#!/bin/bash
set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(dirname "$SCRIPT_DIR")"
REHOST_DIR="$HOME/.local/share/rehost"
MIGRATIONS_DIR="$REHOST_DIR/migrations"

# Check for force flag or specific migration to rerun
FORCE=false
RERUN_MIGRATION=""
while [[ $# -gt 0 ]]; do
    case $1 in
        --force|-f)
            FORCE=true
            shift
            ;;
        --rerun)
            RERUN_MIGRATION="$2"
            shift 2
            ;;
        *)
            echo "Unknown option: $1"
            echo "Usage: $0 [--force] [--rerun MIGRATION_NAME]"
            echo "  --force, -f: Run all migrations even if already completed"
            echo "  --rerun MIGRATION_NAME: Rerun a specific migration (e.g., --rerun 1758425207_install_cli_tools.sh)"
            exit 1
            ;;
    esac
done

echo "Running prechecks..."
if ! "$PROJECT_ROOT/install/prechecks.sh"; then
    echo "Prechecks failed. Please fix the issues and try again."
    exit 1
fi

mkdir -p "$MIGRATIONS_DIR/system" "$MIGRATIONS_DIR/user"

run_migration() {
    local script="$1"
    local type="$2"
    local name=$(basename "$script")

    # Skip if already run, unless force flag is set or this is the specific migration to rerun
    if [ -f "$MIGRATIONS_DIR/$type/$name" ] && [ "$FORCE" != "true" ] && [ "$name" != "$RERUN_MIGRATION" ]; then
        echo "  ⊙ Skipping: $name"
        return 0
    fi

    echo "  → Running: $name"

    if [ "$type" = "system" ] && [ "$(whoami)" != "root" ]; then
        sudo bash "$script"
    else
        bash "$script"
    fi

    cp "$script" "$MIGRATIONS_DIR/$type/"
    echo "  ✓ Completed: $name"
}

# Run system migrations first
if [ -d "$PROJECT_ROOT/migrations/system" ]; then
    echo "System migrations:"
    for script in "$PROJECT_ROOT/migrations/system"/*.sh; do
        [ -f "$script" ] || continue
        run_migration "$script" "system"
    done
fi

# Run user migrations
if [ -d "$PROJECT_ROOT/migrations/user" ]; then
    echo "User migrations:"
    for script in "$PROJECT_ROOT/migrations/user"/*.sh; do
        [ -f "$script" ] || continue
        run_migration "$script" "user"
    done
fi

echo "Setup completed!"
echo "Migrations stored in: $MIGRATIONS_DIR"