#!/bin/bash
set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(dirname "$SCRIPT_DIR")"
REHOST_DIR="$HOME/.local/share/rehost"
MIGRATIONS_DIR="$REHOST_DIR/migrations"
STATE_FILE="$REHOST_DIR/migration.state"

echo "Running prechecks..."
if ! "$PROJECT_ROOT/install/prechecks.sh"; then
    echo "Prechecks failed. Please fix the issues and try again."
    exit 1
fi

mkdir -p "$MIGRATIONS_DIR/system" "$MIGRATIONS_DIR/user"
touch "$STATE_FILE"

has_run() {
    grep -q "^$1$" "$STATE_FILE" 2>/dev/null
}

run_migration() {
    local script="$1"
    local type="$2"
    local name=$(basename "$script")

    if has_run "$type/$name"; then
        echo "  ⊙ Skipping: $name"
        return 0
    fi

    echo "  → Running: $name"

    if [ "$type" = "system" ] && [ "$(whoami)" != "root" ]; then
        sudo bash "$script"
    else
        bash "$script"
    fi

    echo "$type/$name" >> "$STATE_FILE"
    cp "$script" "$MIGRATIONS_DIR/$type/"
    echo "  ✓ Completed: $name"
}

# Run system migrations first
if [ -d "$PROJECT_ROOT/migrations/system" ]; then
    echo "System migrations:"
    for script in "$PROJECT_ROOT/migrations/system"/*.sh; do
        [ -f "$script" ] || continue
        run_migration "$script" "system"
    done
fi

# Run user migrations
if [ -d "$PROJECT_ROOT/migrations/user" ]; then
    echo "User migrations:"
    for script in "$PROJECT_ROOT/migrations/user"/*.sh; do
        [ -f "$script" ] || continue
        run_migration "$script" "user"
    done
fi

echo "Setup completed!"
echo "Migrations stored in: $MIGRATIONS_DIR"